---
title: "COVID and variancePartition"
subtitle: ''
author: "Developed by [Gabriel Hoffman](http://gabrielhoffman.github.io/)"
date: "Run on `r Sys.time()`"
documentclass: article
output: 
  html_document:
  toc: true
  smart: false
---


<!---

cd /hpc/users/hoffmg01/work/misc_vp
# rm -rf molec_profiling_cache/
ml git pandoc 
git pull
R

system("git pull"); rmarkdown::render("covid_vp.Rmd")



--->

```{r setup, include=FALSE}
suppressPackageStartupMessages({
library(ggplot2)
library(data.table)
library(cowplot)
library(kableExtra)
library(knitr)
library(compositions)
library(BiocParallel)

library(limma)
library(edgeR)
library(variancePartition)

})

knitr::opts_chunk$set(
  echo = FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE,
  cache = TRUE)
```


```{r define}
plot_within_btw = function( simMat, design, col=c("lightblue", "lightgreen"),main='',ylim=NULL,...){
  variation = list(type=c(), value=c(), donor1=c(), donor2=c())
  for(i in 1:ncol(design)){
    idx1 = which(design[,i] == 1)   
    idx0 = which(design[,i] == 0)
    C_sub = simMat[idx1, idx1]
    variation$type = append( variation$type, rep("Same Donor", sum(lower.tri(C_sub))) )  
    variation$value = append( variation$value, C_sub[lower.tri(C_sub)])   
    variation$donor1 = append(variation$donor1, rep(colnames(design)[i], length(C_sub[lower.tri(C_sub)]) ))      
    variation$donor2 = append(variation$donor2, rep(colnames(design)[i], length(C_sub[lower.tri(C_sub)]) ))
    variation$type = append( variation$type, rep("Different Donor", length(simMat[idx1,idx0])) )  
    variation$value = append( variation$value, simMat[idx1,idx0])    
    variation$donor1 = append(variation$donor1, rep("", length(simMat[idx1,idx0])) )      
    variation$donor2 = append(variation$donor2, rep("", length(simMat[idx1,idx0])))
  }
  variation = as.data.frame(variation)
  fig = ggplot( variation, aes(type, value)) + geom_violin(scale = "width", aes(fill=type)) + 
    ylab("Variance explained (%)") + xlab("") + geom_boxplot(width = 0.07, 
        fill = "grey", outlier.color = "black") + theme_bw(15) + theme(plot.title = element_text(hjust = 0.5))+ 
        scale_fill_manual(values = col) + theme(legend.position = "none") + 
        ylab("Correlation between samples") + scale_fill_manual(values=c("grey", "steelblue1"))
    if( main !='' ){
      fig = fig + ggtitle( main )
    }
    if( !is.null(ylim) ){
      fig = fig + ylim( ylim )
    }
    fig = fig + theme(aspect.ratio=1)
    return(list(fig=fig, variation=variation))
}
```

# read data
```{r ct.read}

info = read.table("/sc/arion/projects/CommonMind/roussp01a/COVID_SC/FrozenBrain/results/freq_celltype.csv", sep=',', header=TRUE)
info$covid = factor(info$covid)
info$subject = factor(info$subject)

info$Biosample = factor(with(info, paste(subject, pid, tissue)))

table(info$pid)
table(info$subject)
table(info$clinical)
table(info$tissue)
table(info$covid)
```

# Variance partitioning
Compute variance partitioning for cell fractions (log ratios) for the whole dataset and then each tissue.  The `clr` transformation computes the log ration of each cell type fraction compared to a single, centered value.  The macrophage signal is only apparent with this transformation.

### Hierarchical clustering
```{r CT.hclust, fig.width=16}
# use observed cell type frations
# CT.quant = t(info[,1:15])

# use centered log ratios
pseudoFrac = 1e-2
CT.quant = t(clr(info[,1:15] + pseudoFrac))

D = 1 - cor(CT.quant)
colnames(D) = info$Biosample
hcl = hclust(as.dist(D))
plot(hcl)
colnames(CT.quant) = 1:ncol(CT.quant)
```

### PCA
```{r pca, fig.width=12, fig.height=6}
dcmp = prcomp( t(CT.quant) )
info = cbind(info, dcmp$x[,1:4])
rownames(info) = c()

ggplot( info, aes(PC1, PC2, color=subject, shape=tissue)) + geom_point() + theme_bw() + theme(aspect.ratio=1)
```

### Compare similarity between samples from same or different donors for each brain region
```{r, within.between, fig.width=12, fig.height=6}
figList = lapply( sort(unique(info$tissue)), function(Tissue){
  idx = which(info$tissue == Tissue)
  C = cor(CT.quant, method="spearman")
  dsgn = model.matrix(~0+subject, info[idx,])

  res = plot_within_btw( C[idx,idx], dsgn)

  wt = with( unique(res$variation), wilcox.test( value[type=="Same Donor"], value[type=="Different Donor"], alternative="greater"))

  res$fig + ggtitle( paste0(Tissue, ": (p=", format(wt$p.value, digits=3), ')') ) + ylim(-0.5, 1)
})
plot_grid( plotlist=figList, nrow=1)
```





```{r cancor, fig.width=6, fig.height=6, eval=FALSE}
C = canCorPairs(~ pid + subject + covid + tissue + Biosample, info)

plotCorrMatrix(C)
```

There are 4 samples per subject per brain region.  These 4 samples represent 2 disections and 2 10X runs.  I refer to the same `Biosample`  to mean to same physical piece of tissue run on two 10X batches.    So even though there are 108 samples, there are only 9 subjects.  This is exactly the problem that `dream` (by calling `lmer`) is meant to address.  Ignoring the repeated measures can lead to false positives.  See [Jostins, et al, PNAS 2012](https://www.pnas.org/content/109/18/E1048) for an example. 


```{r facet_wrap, fig.width=12, fig.height=30}
df  = cbind(info[,16:22], t(CT.quant))
df_melt = reshape2::melt(df, id.vars=colnames(info[,16:22]))

ggplot(df_melt, aes(subject, value, color=covid)) + geom_point() + theme_bw() + theme(aspect.ratio=1, axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + facet_wrap(~ variable + tissue, ncol=3) + ylim('Centered log ratio')
```

### Variance partition for the entire dataset

```{r CT.vp}
# form = ~ (1|pid) + (1|subject) + (1|covid) + (1|tissue) 
form = ~ (1|pid) + (1|subject) + (1|covid) + (1|tissue) + (1|Biosample)

vp = fitExtractVarPartModel( CT.quant, form, info)   

plotPercentBars(vp)
``` 

### Variance partition for each tissue
```{r per.tissue, fig.width=12}
form = ~ (1|pid) + (1|subject) + (1|covid) + (1|Biosample)
vpList = lapply( unique(info$tissue), function(Tissue){

  idx = which(info$tissue == Tissue)
 
  fitExtractVarPartModel( CT.quant[,idx], form, info[idx,]) 
})
names(vpList) = unique(info$tissue)

figList = lapply( names(vpList), function(id){
  plotPercentBars( vpList[[id]] ) + ggtitle(id) + theme(legend.position="bottom")
  })   

plot_grid(plotlist = figList, ncol=3)
```

### Hypothesis testing for each tissue
```{r per.tissue.dream, fig.width=12}
form = ~ (1|pid) + (1|subject) + covid + (1|Biosample)

tissues = sort(unique(info$tissue))
fitList = lapply( tissues, function(Tissue){

  idx = which(info$tissue == Tissue)
 
  cellFrac = data.frame(CT.quant[,idx], check.names=FALSE)

  dream( cellFrac, form, info[idx,]) 
})
names(fitList) = tissues


tabList = lapply( tissues, function(Tissue){

  fit = fitList[[Tissue]]

  df = topTable(fit, coef="covid1", sort.by='none', number=Inf)

  df$Tissue = Tissue
  df$CT = rownames(df)

  df
})
tab = do.call(rbind, tabList)

tab$FDR = p.adjust(tab$P.Value, "fdr")

ggplot(tab, aes(CT, z.std, fill=(FDR < 0.10))) + geom_bar(stat="identity") + facet_wrap(~Tissue) + theme_bw() + theme(aspect.ratio=1) + coord_flip() + scale_fill_manual(values=c("black", "red"))
```







```{r read.gene.expression, eval=FALSE}
geneExpr = fread('/sc/arion/projects/CommonMind/roussp01a/COVID_SC/FrozenBrain/results/gene_expression_v10k.csv')
metadata = fread('/sc/arion/projects/CommonMind/roussp01a/COVID_SC/FrozenBrain/results/metadata.csv')
```









